<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adastral Park Trail + Compass</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7l57TFhjYSpFeVY1FsiKxtogVV1QfmRM&libraries=maps,marker&v=beta"></script>
<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; text-align:center; }
  #map { height:45vh; width:100%; }
  #controls { padding:0.5rem; background:#fff; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; align-items:center; }
  button, select { padding:10px 14px; border:none; border-radius:8px; font-size:16px; }
  button { background:#0057b8; color:white; cursor:pointer; }
  button:disabled { background:#aaa; cursor:not-allowed; }
  select { background:#eee; cursor:pointer; }
  #nearest { padding:0.5rem; background:#fff; font-weight:bold; }
  #trailList { padding:0.5rem; text-align:left; }

  .trail-item {
    display:flex; align-items:center; background:#fff; margin:6px 0;
    padding:10px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .img-wrap { position:relative; width:70px; height:70px; margin-right:10px; }
  .trail-item img { width:70px; height:70px; border-radius:8px; object-fit:cover; display:block; }
  .tick-overlay {
    position:absolute; inset:0; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(0,128,0,0.15); color:#0a0; font-size:28px; font-weight:700;
    opacity:0; transition:opacity .2s ease;
  }
  .visited .tick-overlay { opacity:1; }
  .trail-info { flex:1; }
  .trail-name { font-weight:bold; color:#0057b8; margin:0; display:flex; align-items:center; gap:6px; }
  .trail-dist { font-size:13px; color:#666; }
  .tick { font-size:18px; color:green; visibility:hidden; }
  .visited .tick { visibility:visible; }
  .visited img { opacity:0.6; }
  .read-more { background:#007bff; color:white; padding:6px 10px; border:none; border-radius:6px; }

  #compass {
    width:100%; background:#fff; display:flex;
    flex-direction:column; align-items:center; justify-content:center;
    border-top:1px solid #ddd; margin-top:5px; padding:10px 0;
  }
  #arrow {
    width:80px; height:80px; transition:transform 0.2s linear, filter 0.3s ease;
    filter: grayscale(100%) brightness(0.6);
  }
  #arrow.active { filter: none; }
  #arrow.arrived { filter: hue-rotate(90deg) brightness(1.1); }
  #compassStatus { font-size:14px; color:#444; margin-top:6px; }
  .user-dot, .next-dot { width:18px; height:18px; border-radius:50%; border:2px solid white; }
  .user-dot {
    background: radial-gradient(circle, yellow 40%, orange 80%);
    box-shadow:0 0 8px rgba(255,255,0,0.8); animation: flash 1s infinite alternate;
  }
  .next-dot {
    background: radial-gradient(circle, #00b2ff 30%, #0057b8 80%);
    box-shadow:0 0 10px rgba(0,150,255,0.8); animation: pulse 1.6s infinite ease-in-out;
  }
  @keyframes flash { 0%{opacity:1;}100%{opacity:0.6;} }
  @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.5);}100%{transform:scale(1);} }

  /* Modal */
  dialog { border:none; border-radius:12px; padding:0; max-width:700px; width:min(94vw, 700px); }
  .modal-inner { padding:16px; text-align:left; }
  .modal-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .modal-header h3 { margin:0; }
  .modal-body img { width:100%; border-radius:10px; margin-bottom:12px; }
  .modal-body p { margin:0 0 10px 0; line-height:1.45; white-space:pre-wrap; }
  .btn-secondary { background:#eee; color:#333; }
</style>
</head>
<body>
<div id="map"></div>

<div id="controls">
  <button id="updateBtn">üîÑ Update My Position</button>
  <button id="startCompassBtn">üß≠ Enable Compass</button>
  <button id="resetBtn" title="Clear progress">‚ôªÔ∏è Reset Trail</button>
  <select id="testSelect"><option value="">üß™ Test location‚Ä¶</option></select>
</div>

<div id="nearest">Nearest point: <span id="nearestName">‚Äì</span></div>

<div id="compass">
  <img id="arrow" src="images/arrow.svg" alt="Compass Arrow">
  <p id="headingText">Heading: 0¬∞</p>
  <p id="compassStatus">Waiting for motion permission...</p>
</div>

<div id="trailList"></div>

<dialog id="spotModal" aria-labelledby="spotTitle">
  <div class="modal-inner">
    <div class="modal-header">
      <h3 id="spotTitle"></h3>
      <button id="closeModal" class="btn-secondary">‚úñ Close</button>
    </div>
    <div id="spotBody" class="modal-body"></div>
  </div>
</dialog>

<script>
// ---- config ----
const IMAGE_EXT="jpg";
const IMAGE_PATH="images/";

// ---- data (trimmed for brevity; keep your full list) ----
const spots=[ /* ... your 17 spots as in previous version ... */ ];

// derive image filenames
const toFileName=name=>name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'')+'.'+IMAGE_EXT;
spots.forEach(s=>s.img=IMAGE_PATH+toFileName(s.name));

// ---- helpers ----
function haversine(lat1,lon1,lat2,lon2){const R=6371000,toRad=Math.PI/180;
const dLat=(lat2-lat1)*toRad,dLon=(lon2-lon1)*toRad;
const a=Math.sin(dLat/2)**2+Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function bearing(lat1,lon1,lat2,lon2){const toRad=Math.PI/180,toDeg=180/Math.PI;
const œÜ1=lat1*toRad,œÜ2=lat2*toRad,ŒîŒª=(lon2-lon1)*toRad;
const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
return (Math.atan2(y,x)*toDeg+360)%360;}
const toKey=n=>n.replace(/\s+/g,'_');

// ---- state ----
let map,userMarker,nextMarker,spotMarkers=[];
let watchId=null,testingMode=false;
let visited=new Set(JSON.parse(localStorage.getItem("visitedSpots")||"[]"));
let userPos=JSON.parse(localStorage.getItem("lastUserPos")||'{"lat":52.0579,"lng":1.2800}');
let compassHeading=0,nearestCache=null;

// ---- map ----
function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:userPos,zoom:17,mapId:"YOUR_MAP_ID_HERE"});
  userMarker=new google.maps.marker.AdvancedMarkerElement({map,position:userPos,content:Object.assign(document.createElement('div'),{className:'user-dot'})});
  nextMarker=new google.maps.marker.AdvancedMarkerElement({map,position:userPos,content:Object.assign(document.createElement('div'),{className:'next-dot'})});
  spotMarkers=spots.map(s=>{
    const el=document.createElement('div');
    el.style.width='14px';el.style.height='14px';el.style.border='2px solid white';el.style.borderRadius='50%';
    el.style.background=visited.has(s.name)?'linear-gradient(#4caf50,#2e7d32)':'linear-gradient(#00b2ff,#0057b8)';
    return new google.maps.marker.AdvancedMarkerElement({map,position:{lat:s.lat,lng:s.lng},content:el,title:s.name});
  });
  buildList();setupCompassButton();attachBasicHandlers();buildTestDropdown();startWatchingPosition();refreshNearestAndDistances();
}

// ---- list ----
function buildList(){
  const list=document.getElementById("trailList");list.innerHTML="";
  spots.forEach(s=>{
    const v=visited.has(s.name);
    const btnLabel=v?"Read more":"Find spot to read more‚Ä¶";
    const item=document.createElement("div");
    item.className="trail-item"+(v?" visited":"");
    item.innerHTML=`
      <div class="img-wrap">
        <img src="${s.img}" alt="${s.name}">
        <div class="tick-overlay">‚úî</div>
      </div>
      <div class="trail-info">
        <p class="trail-name">${s.name}<span class="tick">‚úî</span></p>
        <p class="trail-dist" id="dist-${toKey(s.name)}">‚Äì</p>
        <button class="read-more" data-spot="${s.name}" ${v?"":"disabled"}>${btnLabel}</button>
      </div>`;
    item.querySelector(".read-more").addEventListener("click",e=>openSpotModal(e.currentTarget.dataset.spot));
    list.appendChild(item);
  });
}

// ---- geolocation ----
function startWatchingPosition(){if(!navigator.geolocation||testingMode)return;
if(watchId)navigator.geolocation.clearWatch(watchId);
watchId=navigator.geolocation.watchPosition(pos=>{if(testingMode)return;
userPos={lat:pos.coords.latitude,lng:pos.coords.longitude};onPositionUpdated();},
()=>{}, {enableHighAccuracy:true,maximumAge:1500,timeout:15000});}
function onPositionUpdated(){localStorage.setItem("lastUserPos",JSON.stringify(userPos));
map.setCenter(userPos);userMarker.position=userPos;refreshNearestAndDistances();}
function findNearest(lat,lng){let min=Infinity,nearest=null;
spots.forEach(s=>{const d=haversine(lat,lng,s.lat,s.lng);if(d<min){min=d;nearest={...s,dist:d};}});
return nearest;}
function refreshNearestAndDistances(){
  const nearest=findNearest(userPos.lat,userPos.lng);nearestCache=nearest;
  document.getElementById("nearestName").textContent=`${nearest.name} (${nearest.dist.toFixed(0)} m)`;
  nextMarker.position={lat:nearest.lat,lng:nearest.lng};
  let changed=false;
  spots.forEach((s,i)=>{
    const d=haversine(userPos.lat,userPos.lng,s.lat,s.lng);
    const el=document.getElementById("dist-"+toKey(s.name));
    if(el)el.textContent=d<1000?`${d.toFixed(0)} m`:`${(d/1000).toFixed(2)} km`;
    if(d<=10&&!visited.has(s.name)){visited.add(s.name);changed=true;
      spotMarkers[i].content.style.background='linear-gradient(#4caf50,#2e7d32)';}
  });
  if(changed){localStorage.setItem("visitedSpots",JSON.stringify([...visited]));buildList();}
  aimCompassAtNearest();
}

// ---- compass ----
function setupCompassButton(){
  const btn=document.getElementById("startCompassBtn");
  const arrow=document.getElementById("arrow");
  const status=document.getElementById("compassStatus");
  btn.addEventListener("click",()=>{
    status.textContent="Requesting motion permission...";
    if(typeof DeviceOrientationEvent!=="undefined"&&typeof DeviceOrientationEvent.requestPermission==="function"){
      DeviceOrientationEvent.requestPermission().then(res=>{
        if(res==="granted"){
          window.addEventListener("deviceorientation",handleOrientation,true);
          btn.textContent="üß≠ Compass Active";btn.disabled=true;arrow.classList.add("active");
          status.textContent="Compass active ‚úì Rotate your phone!";
        }else status.textContent="Permission denied.";
      }).catch(err=>status.textContent="Compass not supported: "+err);
    }else{
      window.addEventListener("deviceorientationabsolute",handleOrientation,true);
      window.addEventListener("deviceorientation",handleOrientation,true);
      btn.textContent="üß≠ Compass Active";btn.disabled=true;arrow.classList.add("active");
      status.textContent="Compass active ‚úì Rotate your device!";
    }
  });
  function handleOrientation(event){
    let heading;
    if(event.webkitCompassHeading!==undefined){heading=event.webkitCompassHeading;}
    else if(event.alpha!==null){heading=360-event.alpha-180;if(heading<0)heading+=360;}
    if(heading===undefined||isNaN(heading))return;
    compassHeading=heading;aimCompassAtNearest();
  }
}
function aimCompassAtNearest(){
  if(!nearestCache)return;
  const arrow=document.getElementById("arrow");
  const brg=bearing(userPos.lat,userPos.lng,nearestCache.lat,nearestCache.lng);
  const rel=(brg-compassHeading+360)%360;
  arrow.style.transform=`rotate(${rel}deg)`;
  if(nearestCache.dist<=10)arrow.classList.add("arrived");else arrow.classList.remove("arrived");
  document.getElementById("headingText").textContent=`Heading: ${compassHeading.toFixed(1)}¬∞`;
  document.getElementById("compassStatus").textContent=`Arrow ‚Üí ${nearestCache.name} (${nearestCache.dist.toFixed(0)} m)`;
}

// ---- modal ----
const spotModal=document.getElementById("spotModal");
document.getElementById("closeModal").onclick=()=>spotModal.close();
function openSpotModal(name){
  const s=spots.find(x=>x.name===name);if(!s)return;
  const infoHtml=`<p>${(s.info||"").trim().replace(/\n{2,}/g,"</p><p>").replace(/\n/g,"<br>")}</p>`;
  document.getElementById("spotTitle").textContent=s.name;
  document.getElementById("spotBody").innerHTML=`<img src="${s.img}" alt="${s.name}">${infoHtml}<p><strong>Location:</strong> ${s.lat.toFixed(6)}, ${s.lng.toFixed(6)}</p>`;
  spotModal.showModal();
}

// ---- controls ----
function attachBasicHandlers(){
  document.getElementById("updateBtn").onclick=()=>navigator.geolocation&&navigator.geolocation.getCurrentPosition(p=>{userPos={lat:p.coords.latitude,lng:p.coords.longitude};onPositionUpdated();});
  document.getElementById("resetBtn").onclick=()=>{if(!confirm("Reset your trail progress?"))return;
    visited.clear();localStorage.removeItem("visitedSpots");spotMarkers.forEach(m=>m.content.style.background='linear-gradient(#00b2ff,#0057b8)');buildList();};
}
function buildTestDropdown(){
  const sel=document.getElementById("testSelect");
  spots.forEach(s=>{const o=document.createElement("option");o.value=JSON.stringify({lat:s.lat,lng:s.lng,name:s.name});o.textContent=s.name;sel.appendChild(o);});
  sel.addEventListener("change",e=>{
    const val=e.target.value;
    if(!val){testingMode=false;startWatchingPosition();alert("‚úÖ Returned to live GPS mode.");return;}
    testingMode=true;if(watchId)navigator.geolocation.clearWatch(watchId);
    const loc=JSON.parse(val);userPos={lat:loc.lat,lng:loc.lng};onPositionUpdated();
    alert(`üß™ Spoofed location set to "${loc.name}".`);
  });
}

// ---- boot ----
window.addEventListener("load",initMap);
</script>
</body>
</html>
