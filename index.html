<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adastral Park Trail + Compass</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA7l57TFhjYSpFeVY1FsiKxtogVV1QfmRM&libraries=maps,marker&v=beta"></script>
<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f5f5f5; text-align:center; }
  #map { height:45vh; width:100%; }
  #controls { padding:0.5rem; background:#fff; }
  button { padding:10px 16px; border:none; background:#0057b8; color:white; border-radius:8px; font-size:16px; }
  #nearest { padding:0.5rem; background:#fff; font-weight:bold; }
  #trailList { padding:0.5rem; text-align:left; }
  .trail-item {
    display:flex; align-items:center; background:#fff; margin:6px 0;
    padding:10px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.1);
  }
  .trail-item img { width:70px; height:70px; border-radius:8px; object-fit:cover; margin-right:10px; }
  .trail-info { flex:1; }
  .trail-name { font-weight:bold; color:#0057b8; margin:0; }
  .trail-dist { font-size:13px; color:#666; }
  .tick { font-size:20px; color:green; margin-left:6px; visibility:hidden; }
  .visited .tick { visibility:visible; }
  .visited img { opacity:0.5; }
  .read-more { background:#007bff; color:white; padding:6px 10px; border:none; border-radius:6px; }
  #compass {
    width:100%; height:120px; background:#fff; display:flex;
    flex-direction:column; align-items:center; justify-content:center;
    border-top:1px solid #ddd; margin-top:5px;
  }
  #arrow {
    width:80px; height:80px; transition:transform 0.3s ease-out;
  }
  .user-dot, .next-dot { width:18px; height:18px; border-radius:50%; border:2px solid white; }
  .user-dot { background: radial-gradient(circle, yellow 40%, orange 80%);
    box-shadow:0 0 8px rgba(255,255,0,0.8); animation: flash 1s infinite alternate; }
  .next-dot { background: radial-gradient(circle, #00b2ff 30%, #0057b8 80%);
    box-shadow:0 0 10px rgba(0,150,255,0.8); animation: pulse 1.6s infinite ease-in-out; }
  @keyframes flash { 0%{opacity:1;}100%{opacity:0.6;} }
  @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.5);}100%{transform:scale(1);} }
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="updateBtn">ðŸ”„ Update My Position</button>
</div>
<div id="nearest">Nearest point: <span id="nearestName">â€“</span></div>

<!-- ðŸ§­ Compass Section -->
<div id="compass">
  <img id="arrow" src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Red_Arrow_Up.svg" alt="Compass Arrow">
  <p id="headingText">Heading: 0Â°</p>
</div>

<div id="trailList"></div>

<script>
const spots = [
  { name:"Main Lab Block", lat:52.05674493, lng:1.27986381 },
  { name:"Acoustic Block", lat:52.05671008, lng:1.28002642 },
  { name:"Old Post Room", lat:52.05734795, lng:1.27954631 },
  { name:"B1", lat:52.06050806, lng:1.27999692 },
  { name:"Waveguide", lat:52.06077374, lng:1.28135277 },
  { name:"Submarine, Robotics and Drones", lat:52.0593466, lng:1.28245784 },
  { name:"The Digitech Centre", lat:52.05925789, lng:1.28514944 },
  { name:"Martlesham Teleport", lat:52.05930828, lng:1.28618477 },
  { name:"ROMES", lat:52.05926545, lng:1.2858495 },
  { name:"Smart Home", lat:52.0592116, lng:1.28462507 },
  { name:"Sports Hall", lat:52.05920839, lng:1.28417848 },
  { name:"Gaming", lat:52.05886422, lng:1.28180741 },
  { name:"Emergency Services", lat:52.05734862, lng:1.28259329 },
  { name:"Network Ops", lat:52.05718534, lng:1.2811905 },
  { name:"Innovation Martlesham", lat:52.05744922, lng:1.2811905 },
  { name:"Heritage Centre", lat:52.05891122, lng:1.27937062 }
];

let map, userMarker, nextMarker;
let visited = new Set(JSON.parse(localStorage.getItem("visitedSpots")||"[]"));
let userPos = {lat:52.0579, lng:1.2800};
let compassHeading = 0;

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000,toRad=Math.PI/180;
  const dLat=(lat2-lat1)*toRad,dLon=(lon2-lon1)*toRad;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function findNearest(lat,lng){
  let min=Infinity,nearest=null;
  spots.forEach(s=>{
    const d=haversine(lat,lng,s.lat,s.lng);
    if(d<min){min=d;nearest={...s,dist:d};}
  });
  return nearest;
}

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:userPos,zoom:17,mapId:"DEMO_MAP_ID"});
  userMarker=new google.maps.marker.AdvancedMarkerElement({
    map,position:userPos,content:Object.assign(document.createElement('div'),{className:'user-dot'})
  });
  nextMarker=new google.maps.marker.AdvancedMarkerElement({
    map,position:userPos,content:Object.assign(document.createElement('div'),{className:'next-dot'})
  });
  buildList();
  startCompass(); // ðŸ§­ start compass here
}

function buildList(){
  const list=document.getElementById("trailList");
  list.innerHTML="";
  spots.forEach(s=>{
    const item=document.createElement("div");
    item.className="trail-item"+(visited.has(s.name)?" visited":"");
    item.innerHTML=`
      <img src="https://via.placeholder.com/80">
      <div class="trail-info">
        <p class="trail-name">${s.name}<span class="tick">âœ”</span></p>
        <p class="trail-dist" id="dist-${s.name.replace(/\s+/g,'_')}">â€“</p>
        <button class="read-more" disabled>Read More</button>
      </div>`;
    list.appendChild(item);
  });
}

function updatePosition(){
  if(!navigator.geolocation){alert("No GPS support");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    userPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
    map.setCenter(userPos);
    userMarker.position=userPos;

    const nearest=findNearest(userPos.lat,userPos.lng);
    document.getElementById("nearestName").textContent=`${nearest.name} (${nearest.dist.toFixed(0)} m)`;
    nextMarker.position={lat:nearest.lat,lng:nearest.lng};

    spots.forEach(s=>{
      const d=haversine(userPos.lat,userPos.lng,s.lat,s.lng);
      const el=document.getElementById("dist-"+s.name.replace(/\s+/g,'_'));
      if(el)el.textContent=d<1000?`${d.toFixed(0)} m`:`${(d/1000).toFixed(2)} km`;
      if(d<=10 && !visited.has(s.name)){
        visited.add(s.name);
        localStorage.setItem("visitedSpots",JSON.stringify([...visited]));
      }
    });
    buildList();
  },err=>alert("GPS error: "+err.message));
}

// ðŸ§­ COMPASS FUNCTION
function startCompass(){
  function handleOrientation(event){
    let heading;
    if(event.webkitCompassHeading!==undefined) heading=event.webkitCompassHeading;
    else if(event.alpha!==null) heading=360-event.alpha;
    if(heading===undefined||isNaN(heading)) return;
    compassHeading=heading;
    document.getElementById("arrow").style.transform=`rotate(${heading}deg)`;
    document.getElementById("headingText").textContent=`Heading: ${heading.toFixed(1)}Â°`;
  }

  if(typeof DeviceOrientationEvent!=="undefined" &&
     typeof DeviceOrientationEvent.requestPermission==="function"){
    DeviceOrientationEvent.requestPermission()
      .then(res=>{
        if(res==="granted"){
          window.addEventListener("deviceorientation",handleOrientation,true);
        }else{
          alert("Compass permission denied");
        }
      })
      .catch(()=>alert("Compass not supported"));
  }else{
    window.addEventListener("deviceorientationabsolute",handleOrientation,true);
    window.addEventListener("deviceorientation",handleOrientation,true);
  }
}

document.getElementById("updateBtn").addEventListener("click",updatePosition);
window.addEventListener('load', initMap);
</script>
</body>
</html>
